<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CSI Data Quality Analyzer – Dashboard</title>

  <!-- Plotly (charts) -->
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>

  <!-- PapaParse (read CSV in browser) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 24px; line-height: 1.35; }
    .grid { display: grid; gap: 16px; grid-template-columns: 1fr; }
    @media (min-width: 900px) { .grid { grid-template-columns: 1.2fr 0.8fr; } }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 16px; }
    .muted { color: #555; }
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    th, td { border-bottom: 1px solid #eee; padding: 8px; text-align: left; }
    img { max-width: 100%; border: 1px solid #eee; border-radius: 8px; }
    code { background: #f6f6f6; padding: 2px 6px; border-radius: 6px; }
  </style>
  <style>
  body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    background-color: #f8fafc;
    color: #111827;
    margin: 0;
    padding: 1.5rem 2rem;
  }

  h1, h2, h3 {
    font-weight: 600;
    color: #0f172a;
  }

  a {
    color: #0f766e;
    text-decoration: none;
  }

  a:hover {
    text-decoration: underline;
  }

  section {
    margin-bottom: 2.5rem;
    max-width: 1100px;
  }

  .note {
    font-size: 0.9rem;
    color: #4b5563;
  }
</style>

</head>

<body>
  <h1>CSI Data Quality Analyzer – Dashboard</h1>
  <p class="muted">
    This page visualizes example outputs produced by the CSI Data Quality Analyzer.
    Data shown here comes from aggregated CSV summaries (no raw GIS data is published).
  </p>

  <p class="muted">
  Data source: CSI sample (Circoscrizione 7) – aggregated outputs only (no raw GIS data).
  </p>


  <div class="grid">
    <div class="card">
      <h2>3D Readiness (UNITA_VOLUMETRICA)</h2>
      <div id="chart3d" style="height:420px;"></div>
      <p class="muted">
        Source: <code>examples/summary_unita_volumetrica_sample.csv</code>
      </p>
    </div>

    <div class="card">
      <h2>Key numbers</h2>
      <table id="kv"></table>
      <p class="muted" id="meta"></p>
    </div>
  </div>

  <div class="card" style="margin-top:16px;">
    <h2>Maps (exported from QGIS)</h2>
    <p class="muted">
      Add screenshots/exports as PNGs to <code>docs/assets/</code> and they will appear here.
    </p>
    <div style="display:grid; gap:12px; grid-template-columns: 1fr; @media (min-width: 900px){grid-template-columns:1fr 1fr;}">
      <div>
        <h3>2D Map</h3>
        <img src="assets/map_2d.png" alt="2D map (QGIS export)" />
      </div>
      <div>
        <h3>3D View</h3>
        <img src="assets/map_3d.png" alt="3D view (QGIS export)" />
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:16px;">
    <h2>Layer overview (sample)</h2>
    <div id="layerTable"></div>
    <p class="muted">
      Source: <code>examples/summary_layers_sample.csv</code>
    </p>
  </div>

  <section id="height-map">
  <h2>Interactive Height Availability Map (Circoscrizione 7)</h2>
  <p>
    This map shows, for each volumetric unit, whether the dataset contains
    usable height information (<code>OK</code>) or is missing critical
    vertical attributes (<code>MISSING</code>). The visualization is based
    on the <code>has_height</code> field derived from QT_GRONDA and QT_SUOLO.
  </p>

  <p>
    <a href="interactive/c7_height_map/index.html" target="_blank">
      Open map in a separate tab
    </a>
  </p>

  <iframe
      src="interactive/c7_height_map/index.html"
      title="Height availability map – Circoscrizione 7"
      style="width: 100%; max-width: 1100px; height: 600px; border: 1px solid #ccc; border-radius: 4px;">
  </iframe>
</section>

<script>
  function loadCSV(path) {
    return new Promise((resolve, reject) => {
      Papa.parse(path, {
        download: true,
        header: true,
        dynamicTyping: true,
        skipEmptyLines: true,
        complete: results => resolve(results.data),
        error: err => reject(err)
      });
    });
  }

  function renderKV(row) {
    const fields = [
      ["Buildings (n_features)", row.n_features],
      ["Height available (%)", row.pct_height_available],
      ["QT_GRONDA zero/null (%)", row.pct_qt_gronda_zero_or_null],
      ["QT_SUOLO zero/null (%)", row.pct_qt_suolo_zero_or_null],
      ["ALTEZZA_VO null (%)", row.pct_altezza_null]
    ];
    const table = document.getElementById("kv");
    table.innerHTML =
      "<thead><tr><th>Metric</th><th>Value</th></tr></thead>" +
      "<tbody>" +
      fields.map(([k,v]) => `<tr><td>${k}</td><td>${v ?? "N/A"}</td></tr>`).join("") +
      "</tbody>";
  }

  function render3DChart(row) {
    const available = row.pct_height_available ?? 0;
    const missing = 100 - available;

    const data = [{
      type: "bar",
      x: ["Height available", "Missing/zero height"],
      y: [available, missing],
    }];

    const layout = {
      yaxis: { title: "Percent (%)", range: [0, 100] },
      margin: { t: 20, l: 50, r: 20, b: 50 },
    };

    Plotly.newPlot("chart3d", data, layout, {displayModeBar: false});
  }

  function renderLayerTable(rows) {
    // pick a few columns to keep it readable
    const cols = ["layer_name", "n_features", "crs", "geom_types", "pct_missing_any", "top_missing_fields"];
    const header = `<tr>${cols.map(c => `<th>${c}</th>`).join("")}</tr>`;
    const body = rows.map(r =>
      `<tr>${cols.map(c => `<td>${(r[c] ?? "")}</td>`).join("")}</tr>`
    ).join("");

    document.getElementById("layerTable").innerHTML =
      `<table><thead>${header}</thead><tbody>${body}</tbody></table>`;
  }

  async function main() {
    // 3D readiness
    const uv = await loadCSV("examples/summary_unita_volumetrica.csv");
    const row = uv[0];
    renderKV(row);
    render3DChart(row);

    // layers (sample)
    const layers = await loadCSV("examples/summary_layers.csv");
    renderLayerTable(layers);

    document.getElementById("meta").textContent =
      `Layer: ${row.layer_name || "UNITA_VOLUMETRICA"} | Source: ${row.source || "CSI GeoPackage"}`;
  }

  main().catch(err => {
    console.error(err);
    document.body.insertAdjacentHTML("beforeend",
      `<p style="color:red;">Failed to load CSV files. Make sure examples/*.csv exist and paths are correct.</p>`);
  });
</script>
<section id="fiware-comparison">
  <h2>CSI Dataset vs FIWARE Building Model</h2>
  <p class="note">
    This table compares the main building attributes in the CSI dataset
    with the corresponding concepts in the FIWARE Building data model.
    It highlights which CSI fields can be mapped directly and where
    additional enrichment would be required for full interoperability.
  </p>

  <table border="1" cellpadding="6" cellspacing="0" style="border-collapse: collapse;">
    <thead>
      <tr>
        <th>Concept</th>
        <th>CSI (Edificato)</th>
        <th>FIWARE Building model</th>
        <th>Mapping / Gap</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>Unique identifier</td>
        <td><code>ID</code> (or local building ID)</td>
        <td><code>id</code> (URN, e.g. <code>urn:ngsi-ld:Building:001</code>)</td>
        <td>Requires conversion from local numeric ID to FIWARE URN format.</td>
      </tr>
      <tr>
        <td>Geometry (footprint / volume)</td>
        <td><code>UNITA_VOLUMETRICA</code> polygon</td>
        <td><code>location</code> (GeoJSON Polygon / MultiPolygon)</td>
        <td>Direct mapping possible after export to GeoJSON.</td>
      </tr>
      <tr>
        <td>Building height</td>
        <td><code>QT_GRONDA</code>, <code>QT_SUOLO</code>, derived <code>ALTEZZA</code> (sometimes NULL)</td>
        <td><code>height</code> attribute</td>
        <td>Mapping possible where values are present; NULLs require estimation or remain missing.</td>
      </tr>
      <tr>
        <td>Number of floors</td>
        <td><code>NUM_PIANI</code></td>
        <td><code>numberOfFloors</code></td>
        <td>Direct mapping where provided.</td>
      </tr>
      <tr>
        <td>Use / function</td>
        <td><code>CATEG_USO</code> (residential, service, etc.)</td>
        <td><code>category</code> / <code>usage</code></td>
        <td>Requires code list alignment between CSI categories and FIWARE vocabulary.</td>
      </tr>
    </tbody>
  </table>
</section>


</body>
</html>

